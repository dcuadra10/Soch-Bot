// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Kingdom {
  id          Int      @id @default(autoincrement())
  kdNumber    String   @unique // Kingdom number can be something like '1234' or 'K1234'
  name        String
  project     String?  // Optional project/family name
  seed        String   // e.g., 'A', 'B', 'C', 'Imperium'
  powerReq    BigInt   // Using BigInt for large numbers in RoK
  kpReq       BigInt
  kpMultiplier Float?  // For dynamic KP reqs (e.g. 4x Power)
  kvkWins     Int      @default(0)
  kvkLosses   Int      @default(0)
  totalKp     BigInt?  // Kingdom's total KP (Optional)
  migrantSlots Int?    // Available migrant slots (Optional)
  migrationStart DateTime? // Migration Start Date
  migrationEnd   DateTime? // Migration End Date
  ownerId     String   // Discord User ID of the King
  description String?
  imageUrl    String?   // Kingdom Ad/Image
  discordInvite String? // Discord Server Invite
  questions   String?  // Custom questions for applicants
  score       Float    @default(0) // Staff-assigned score
  migrationOpen  DateTime?
  migrationClose DateTime?
  isPaid      Boolean  @default(false)
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tickets     Ticket[]
}

model Ticket {
  id        Int      @id @default(autoincrement())
  channelId String   @unique // The Discord channel ID for this ticket
  userId    String   // The applicant's Discord ID
  kingdomId Int
  status    String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  notified  Boolean  @default(false)
  kingdom   Kingdom  @relation(fields: [kingdomId], references: [id])
  createdAt DateTime @default(now())
  closed    Boolean  @default(false)
}

model UserProfile {
  id            String   @id @default(uuid())
  discordId     String   @unique
  ingameName    String
  ingameId      String
  power         BigInt
  kp            BigInt
  dead          BigInt
  kingdomNumber String
  imageUrl      String
  farms         Int      @default(0)
  ch25Farms     Int      @default(0)
  updatedAt     DateTime @updatedAt
}
model RecruitmentThread {
  id              String   @id // Channel ID of the thread
  ownerId         String
  kingdomId       Int?
  contentHash     String?  // Hash of the starter message content
  lastBumped      DateTime @default(now())
  bumpStrikeCount Int      @default(0)
  bumpBanExpires  DateTime?
  createdAt       DateTime @default(now())
}

model BumpUser {
  id          Int      @id @default(autoincrement())
  threadId    String   @index
  userId      String   @index
  strikeCount Int      @default(0)
  banExpires  DateTime?
  lastBumped  DateTime @default(now())
  @@unique([threadId, userId])
}
